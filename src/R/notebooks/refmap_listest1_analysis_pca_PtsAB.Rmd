---
title: "RefMap Listening test 1 Parts A & B analysis: Principal Components Analysis"
output: html_document
date: "2025-10-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

## Load packages

```{r packages}
# load packages
library(tidyr)
library(ggplot2)
library(conflicted)
library(tidyverse)
library(corrr)
library(openxlsx)
library(stats)
library(easystats)
library(viridis)
library(ggnewscale)
library(patchwork)
library(FactoMineR)
library(factoextra)
# set package parameters
theme_set(theme_bw())

```

## Set parameters

```{r}

# plot colour scheme

mycolourlist = list(c(0, 102, 255), c(0, 204, 153), c(255, 0, 102), c(74, 111, 152), c(251, 164, 49), c(204, 153, 255), c(90, 192, 255), c(80, 245, 233), c(255, 90, 192), c(164, 201, 242), c(255, 254, 139), c(255, 243, 255))
mycolours = matrix()

for (ii in 1:length(mycolourlist)){
  mycolours[ii] = rgb(mycolourlist[[ii]][1]/255,
                      mycolourlist[[ii]][2]/255,
                      mycolourlist[[ii]][3]/255)
}

# toggle to save plots
saveplots = TRUE

if (saveplots){
  # set output plot directory
  choose.files(caption="Just cancel this", filters=matrix(data=c(" ", " "), ncol=2))  # workaround for bug in RTerm choose.dir
  outFigPath <- utils::choose.dir(caption="Select output folder to save plots")
  
  if (!dir.exists(file.path(outFigPath, "svg"))){dir.create(file.path(outFigPath, "svg"))}
  if (!dir.exists(file.path(outFigPath, "pdf"))){dir.create(file.path(outFigPath, "pdf"))}
  
}

# toggle to save data
savedata = TRUE

if (savedata){
  # set output plot directory
  if (saveplots==FALSE){
    choose.files(caption="Just cancel this", filters=matrix(data=c(" ", " "), ncol=2))  # workaround for bug in RTerm choose.dir
  }
  outDataPath <- utils::choose.dir(caption="Select output folder to save data")
}

set.seed(98415616)


```

## Import data and wrangle

### Parts A & B combined

```{r}

stimDataPath <- utils::choose.files(caption=r"(Select refmap_listest1_testdata_ByStim.csv from 03 Experiment\Experiment 1\Analysis\PostProcess)",
                                     filters=matrix(data=c("refmap_listest1_testdata_ByStim.csv", "refmap_listest1_testdata_ByStim.csv"), ncol=2))

stimData <- read.csv(stimDataPath, header=TRUE)

```

```{r}
# definition of ordinal variable levels
UASLAeqCatsA <- c("No UAS", "42", "48", "54", "60")
SNRCatsA <- c("No UAS", "-16", "-10", "-4", "2", "8")
UASOpCatsA <- c("No UAS", "Flyover", "Landing", "Takeoff")
UASTypeCatsA <- c("No UAS", "H520", "M300", "T150")

# omit ambient-only stimuli
stimDataNoAmb <- stimData |> dplyr::filter(UASLAeq != "No UAS")

# re-encode factors omitting ambient-only stimuli
stimDataNoAmb$SNRlevel <- factor(stimDataNoAmb$SNRlevel, levels=SNRCatsA[2:length(SNRCatsA)], order=TRUE)
stimDataNoAmb$UASOperation <- factor(stimDataNoAmb$UASOperation, levels=UASOpCatsA[2: length(UASOpCatsA)])
stimDataNoAmb$UASType <- factor(stimDataNoAmb$UASType, levels=UASTypeCatsA[2:length(UASTypeCatsA)])

# select subset of variables for analysis:
# UASLAEMaxLR, AmbLAeqMaxLR, UASImpulsLoudWZAvgMaxLR,
# UASFluctECMA10ExBin,
# UASRoughFZ05ExMaxLR, UASSharpAurISO305ExBin, UASEvents

stimDataPCA <- stimDataNoAmb |>
  dplyr::select(UASLAEMaxLR,
                UASImpulsLoudWZAvgMaxLR,
                UASFluctECMA10ExBin,
                UASRoughFZ05ExMaxLR,
                UASSharpAurISO305ExBin,
                UASEvents)

res.pca <- PCA(stimDataPCA, scale.unit = T, graph = T)

# plot biplot without 
fviz_pca_var(res.pca, repel = TRUE, 
                col.var = "contrib", # Color by contributions to the PC
                gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")
)
# Contribution of variables to PC1
fviz_contrib(res.pca, choice = "var", axes = 1, top = 10)
# Contribution of variables to PC2
fviz_contrib(res.pca, choice = "var", axes = 2, top = 10)

# scree plot with variance data labels
fviz_screeplot(res.pca, addlabels = TRUE, ylim = c( 0, 100))


fviz_pca_ind(res.pca,
             label = "none", # hide individual labels
             habillage = stimDataNoAmb$UASType, # color by groups
             palette = c("#00AFBB", "#E7B800", "#FC4E07"),
             addEllipses = TRUE # Concentration ellipses
             )
```


## Functions

## Analysis

```{r}



```


